# CoTask æ•°æ®è¿ç§»æŒ‡å— v1 â†’ v2

## ğŸ“‹ è¿ç§»æ¦‚è¿°

æœ¬æ¬¡è¿ç§»å°† CoTask ä»**é¡¹ç›®è§†è§’**å‡çº§ä¸º**ä¸ªäººè§†è§’**çš„ä»»åŠ¡ç®¡ç†ç³»ç»Ÿï¼Œå¼•å…¥é¡¹ç›®çº§æƒé™æ§åˆ¶ã€‚

### ä¸»è¦å˜æ›´

**æ•°æ®åº“ Schema å˜æ›´**:
1. âœ… `projects` è¡¨æ–°å¢ `members` å­—æ®µï¼ˆæ•°ç»„ï¼‰
2. âœ… `tasks` è¡¨æ–°å¢ `created_by`, `created_by_name`, `assigned_time` å­—æ®µ
3. âœ… `tasks` è¡¨æ–°å¢ç´¢å¼•ï¼š`owner_index`, `status_owner_index`

**æƒé™æ¨¡å‹å˜æ›´**:
- ä»ç³»ç»Ÿçº§ç®¡ç†å‘˜ â†’ é¡¹ç›®çº§ç®¡ç†å‘˜
- é¡¹ç›®åˆ›å»ºè€…è‡ªåŠ¨æˆä¸ºé¡¹ç›® Owner
- Owner å¯åˆ†é…ä»»åŠ¡ç»™é¡¹ç›®æˆå‘˜
- æˆå‘˜å¯ä¿®æ”¹è‡ªå·±çš„ä»»åŠ¡

---

## âš ï¸ è¿ç§»å‰å‡†å¤‡

### 1. å¤‡ä»½æ•°æ®ï¼ˆé‡è¦ï¼ï¼‰

åœ¨ HBuilderX ä¸­å¤‡ä»½äº‘æ•°æ®åº“ï¼š
```
1. æ‰“å¼€ HBuilderX
2. æ‰¾åˆ° uniCloud â†’ äº‘æœåŠ¡ç©ºé—´
3. å³é”® â†’ äº‘æ•°æ®åº“ â†’ å¯¼å‡ºæ•°æ®
4. é€‰æ‹©æ‰€æœ‰è¡¨è¿›è¡Œå¤‡ä»½
```

æˆ–ä½¿ç”¨ uniCloud æ§åˆ¶å°ï¼š
```
https://unicloud.dcloud.net.cn/
â†’ é€‰æ‹©é¡¹ç›®
â†’ äº‘æ•°æ®åº“
â†’ å¯¼å‡º
```

### 2. æ£€æŸ¥å½“å‰æ•°æ®

ç¡®ä¿å½“å‰æ•°æ®å®Œæ•´ï¼š
- [ ] æ‰€æœ‰é¡¹ç›®éƒ½æœ‰ `owner_id` å­—æ®µ
- [ ] æ‰€æœ‰ä»»åŠ¡éƒ½æœ‰ `owner_id` å­—æ®µ
- [ ] æ•°æ®åº“è¿æ¥æ­£å¸¸

### 3. æµ‹è¯•ç¯å¢ƒéªŒè¯

å»ºè®®å…ˆåœ¨æµ‹è¯•ç¯å¢ƒæ‰§è¡Œè¿ç§»ï¼š
```
1. åˆ›å»ºæµ‹è¯•äº‘æœåŠ¡ç©ºé—´
2. å¯¼å…¥ç”Ÿäº§æ•°æ®çš„å‰¯æœ¬
3. æ‰§è¡Œè¿ç§»è„šæœ¬
4. éªŒè¯ç»“æœ
5. ç¡®è®¤æ— è¯¯åå†åœ¨ç”Ÿäº§ç¯å¢ƒæ‰§è¡Œ
```

---

## ğŸš€ è¿ç§»æ­¥éª¤

### æ­¥éª¤ 1: ä¸Šä¼ äº‘å‡½æ•°

åœ¨ HBuilderX ä¸­ï¼š

1. **ä¸Šä¼  Schema æ–‡ä»¶**
   ```
   å³é”® uniCloud-aliyun/database/projects.schema.json
   â†’ ä¸Šä¼  Schema å¹¶æ›´æ–°

   å³é”® uniCloud-aliyun/database/tasks.schema.json
   â†’ ä¸Šä¼  Schema å¹¶æ›´æ–°
   ```

2. **ä¸Šä¼ è¿ç§»äº‘å‡½æ•°**
   ```
   å³é”® uniCloud-aliyun/cloudfunctions/migrate_data_to_v2
   â†’ ä¸Šä¼ å¹¶è¿è¡Œ
   ```

3. **ä¸Šä¼ æƒé™å·¥å…·å‡½æ•°åº“**
   ```
   å³é”® uniCloud-aliyun/cloudfunctions/common
   â†’ ä¸Šä¼ å…¬å…±æ¨¡å—
   ```

### æ­¥éª¤ 2: æ‰§è¡Œè¿ç§»

**æ–¹æ³•ä¸€ï¼šåœ¨ HBuilderX ä¸­æ‰§è¡Œ**
```
1. å³é”® migrate_data_to_v2 äº‘å‡½æ•°
2. é€‰æ‹© "äº‘ç«¯è¿è¡Œ"
3. è§‚å¯Ÿæ§åˆ¶å°è¾“å‡º
```

**æ–¹æ³•äºŒï¼šä½¿ç”¨äº‘å‡½æ•°æµ‹è¯•é¢æ¿**
```
1. æ‰“å¼€ uniCloud Web æ§åˆ¶å°
2. äº‘å‡½æ•° â†’ migrate_data_to_v2
3. ç‚¹å‡» "è¿è¡Œæµ‹è¯•"
4. æŸ¥çœ‹æ‰§è¡Œæ—¥å¿—
```

### æ­¥éª¤ 3: éªŒè¯è¿ç§»ç»“æœ

æ‰§è¡Œå®Œæˆåï¼Œæ£€æŸ¥è¿”å›ç»“æœï¼š

**æˆåŠŸç¤ºä¾‹**:
```json
{
  "code": 200,
  "message": "æ•°æ®è¿ç§»å®Œæˆ",
  "data": {
    "projects": {
      "total": 10,
      "success": 10,
      "failed": 0,
      "errors": []
    },
    "tasks": {
      "total": 45,
      "success": 45,
      "failed": 0,
      "errors": []
    }
  }
}
```

**å¦‚æœæœ‰å¤±è´¥è®°å½•**:
```json
{
  "projects": {
    "failed": 1,
    "errors": [
      {
        "project_id": "xxx",
        "project_name": "æµ‹è¯•é¡¹ç›®",
        "error": "é”™è¯¯æè¿°"
      }
    ]
  }
}
```

è¯·è®°å½•å¤±è´¥çš„é¡¹ç›®/ä»»åŠ¡ IDï¼Œæ‰‹åŠ¨å¤„ç†ã€‚

---

## ğŸ” éªŒè¯æ¸…å•

### æ•°æ®å®Œæ•´æ€§éªŒè¯

åœ¨ uniCloud Web æ§åˆ¶å° â†’ äº‘æ•°æ®åº“ä¸­æ£€æŸ¥ï¼š

**1. Projects è¡¨æ£€æŸ¥**
```javascript
// éšæœºæŠ½æŸ¥å‡ ä¸ªé¡¹ç›®
db.collection('projects').limit(5).get()

// éªŒè¯ members å­—æ®µå­˜åœ¨ä¸”æ ¼å¼æ­£ç¡®
{
  members: [
    {
      user_id: "xxx",
      user_name: "å¼ ä¸‰",
      role: "owner",
      join_time: Date
    }
  ]
}
```

**2. Tasks è¡¨æ£€æŸ¥**
```javascript
// éšæœºæŠ½æŸ¥å‡ ä¸ªä»»åŠ¡
db.collection('tasks').limit(5).get()

// éªŒè¯æ–°å­—æ®µå­˜åœ¨
{
  created_by: "xxx",
  created_by_name: "å¼ ä¸‰",
  assigned_time: Date
}
```

**3. æ•°æ®ç»Ÿè®¡å¯¹æ¯”**
```javascript
// è¿ç§»å‰åæ•°æ®é‡åº”ä¸€è‡´
è¿ç§»å‰é¡¹ç›®æ•° = è¿ç§»åé¡¹ç›®æ•°
è¿ç§»å‰ä»»åŠ¡æ•° = è¿ç§»åä»»åŠ¡æ•°
```

### åŠŸèƒ½éªŒè¯

æµ‹è¯•ä»¥ä¸‹åŠŸèƒ½æ˜¯å¦æ­£å¸¸ï¼š

- [ ] ç™»å½•ç³»ç»Ÿ
- [ ] æŸ¥çœ‹é¡¹ç›®åˆ—è¡¨
- [ ] æŸ¥çœ‹é¡¹ç›®è¯¦æƒ…ï¼ˆåº”æ˜¾ç¤ºæˆå‘˜åˆ—è¡¨ï¼‰
- [ ] åˆ›å»ºæ–°é¡¹ç›®ï¼ˆè‡ªåŠ¨æˆä¸º ownerï¼‰
- [ ] æŸ¥çœ‹ä»»åŠ¡è¯¦æƒ…
- [ ] æ›´æ–°ä»»åŠ¡è¿›åº¦

---

## ğŸ”§ è¿ç§»é€»è¾‘è¯´æ˜

### Projects è¡¨è¿ç§»

```
å¯¹äºæ¯ä¸ªé¡¹ç›®:
1. æ£€æŸ¥æ˜¯å¦å·²æœ‰ members å­—æ®µï¼ˆé¿å…é‡å¤è¿ç§»ï¼‰
2. æ·»åŠ é¡¹ç›®è´Ÿè´£äººä¸ºç¬¬ä¸€ä¸ªæˆå‘˜ï¼ˆrole: 'owner'ï¼‰
3. æŸ¥è¯¢è¯¥é¡¹ç›®ä¸‹çš„æ‰€æœ‰ä»»åŠ¡
4. æå–æ‰€æœ‰ä»»åŠ¡è´Ÿè´£äººï¼ˆå»é‡ï¼‰
5. æ·»åŠ ä¸ºé¡¹ç›®æˆå‘˜ï¼ˆrole: 'member'ï¼‰
6. æ›´æ–°é¡¹ç›®çš„ members å­—æ®µ
```

**ç¤ºä¾‹**:
```
è¿ç§»å‰:
{
  _id: "project001",
  name: "å® ç‰©Appå¼€å‘",
  owner: "å¼ ä¸‰",
  owner_id: "user001"
}

è¿ç§»å:
{
  _id: "project001",
  name: "å® ç‰©Appå¼€å‘",
  owner: "å¼ ä¸‰",
  owner_id: "user001",
  members: [
    { user_id: "user001", user_name: "å¼ ä¸‰", role: "owner", join_time: ... },
    { user_id: "user002", user_name: "æå››", role: "member", join_time: ... },
    { user_id: "user003", user_name: "ç‹äº”", role: "member", join_time: ... }
  ]
}
```

### Tasks è¡¨è¿ç§»

```
å¯¹äºæ¯ä¸ªä»»åŠ¡:
1. æ£€æŸ¥æ˜¯å¦å·²æœ‰ created_by å­—æ®µï¼ˆé¿å…é‡å¤è¿ç§»ï¼‰
2. è®¾ç½® created_by = owner_idï¼ˆå‡è®¾ä»»åŠ¡æ˜¯è´Ÿè´£äººè‡ªå·±åˆ›å»ºçš„ï¼‰
3. è®¾ç½® created_by_name = owner
4. è®¾ç½® assigned_time = create_time
```

**ç¤ºä¾‹**:
```
è¿ç§»å‰:
{
  _id: "task001",
  name: "è®¾è®¡æ•°æ®åº“",
  owner: "æå››",
  owner_id: "user002",
  create_time: "2025-01-01"
}

è¿ç§»å:
{
  _id: "task001",
  name: "è®¾è®¡æ•°æ®åº“",
  owner: "æå››",
  owner_id: "user002",
  created_by: "user002",
  created_by_name: "æå››",
  assigned_time: "2025-01-01",
  create_time: "2025-01-01"
}
```

---

## ğŸ”„ å›æ»šæ–¹æ¡ˆ

å¦‚æœè¿ç§»åå‘ç°é—®é¢˜ï¼Œå¯ä»¥å›æ»šï¼š

### æ–¹æ³•ä¸€ï¼šä»å¤‡ä»½æ¢å¤

```
1. æ‰“å¼€ uniCloud æ§åˆ¶å°
2. äº‘æ•°æ®åº“ â†’ å¯¼å…¥
3. é€‰æ‹©ä¹‹å‰å¯¼å‡ºçš„å¤‡ä»½æ–‡ä»¶
4. ç¡®è®¤å¯¼å…¥
```

### æ–¹æ³•äºŒï¼šæ‰‹åŠ¨æ¸…é™¤æ–°å­—æ®µ

åˆ›å»ºå›æ»šäº‘å‡½æ•°ï¼š
```javascript
// rollback_migration.js
const db = uniCloud.database()

// æ¸…é™¤ projects.members
await db.collection('projects').update({
  members: db.command.remove()
})

// æ¸…é™¤ tasks æ–°å­—æ®µ
await db.collection('tasks').update({
  created_by: db.command.remove(),
  created_by_name: db.command.remove(),
  assigned_time: db.command.remove()
})
```

---

## â“ å¸¸è§é—®é¢˜

### Q1: è¿ç§»å¯ä»¥é‡å¤æ‰§è¡Œå—ï¼Ÿ
**A**: å¯ä»¥ã€‚è„šæœ¬ä¼šæ£€æŸ¥å­—æ®µæ˜¯å¦å·²å­˜åœ¨ï¼Œé¿å…é‡å¤è¿ç§»ã€‚

### Q2: è¿ç§»éœ€è¦å¤šä¹…ï¼Ÿ
**A**: å–å†³äºæ•°æ®é‡ã€‚å‚è€ƒæ—¶é—´ï¼š
- 100 ä¸ªé¡¹ç›® + 500 ä¸ªä»»åŠ¡ â‰ˆ 2-3 åˆ†é’Ÿ
- 500 ä¸ªé¡¹ç›® + 2000 ä¸ªä»»åŠ¡ â‰ˆ 5-8 åˆ†é’Ÿ

### Q3: è¿ç§»ä¼šå½±å“çº¿ä¸Šç”¨æˆ·å—ï¼Ÿ
**A**: è¿ç§»è¿‡ç¨‹ä¸­ï¼Œç”¨æˆ·ä»å¯æ­£å¸¸è®¿é—®ã€‚ä½†å»ºè®®åœ¨ä½å³°æœŸæ‰§è¡Œã€‚

### Q4: å¦‚æœæŸäº›é¡¹ç›®æ²¡æœ‰ä»»åŠ¡æ€ä¹ˆåŠï¼Ÿ
**A**: æ­£å¸¸ã€‚è¯¥é¡¹ç›®çš„ members åªä¼šåŒ…å«é¡¹ç›®è´Ÿè´£äººï¼ˆownerï¼‰ã€‚

### Q5: è¿ç§»å¤±è´¥äº†æ€ä¹ˆåŠï¼Ÿ
**A**:
1. æŸ¥çœ‹é”™è¯¯æ—¥å¿—ï¼Œå®šä½å…·ä½“é—®é¢˜
2. ä¿®å¤é—®é¢˜åé‡æ–°æ‰§è¡Œï¼ˆè„šæœ¬æ”¯æŒæ–­ç‚¹ç»­ä¼ ï¼‰
3. å¦‚æ— æ³•ä¿®å¤ï¼Œä»å¤‡ä»½æ¢å¤

---

## ğŸ“ æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·ä¿å­˜ä»¥ä¸‹ä¿¡æ¯ï¼š
- [ ] è¿ç§»æ—¥å¿—ï¼ˆå®Œæ•´çš„æ§åˆ¶å°è¾“å‡ºï¼‰
- [ ] å¤±è´¥è®°å½•ï¼ˆerrors æ•°ç»„ï¼‰
- [ ] æ•°æ®åº“æˆªå›¾ï¼ˆéƒ¨åˆ†å¤±è´¥è®°å½•çš„åŸå§‹æ•°æ®ï¼‰

---

## âœ… è¿ç§»åæ¸…ç†

è¿ç§»æˆåŠŸå¹¶éªŒè¯æ— è¯¯åï¼š

1. **ä¿ç•™ä¸€æ®µæ—¶é—´çš„å¤‡ä»½**ï¼ˆå»ºè®® 7-30 å¤©ï¼‰
2. **å¯é€‰ï¼šåˆ é™¤è¿ç§»äº‘å‡½æ•°**
   ```
   migrate_data_to_v2 äº‘å‡½æ•°ä»…ç”¨äºä¸€æ¬¡æ€§è¿ç§»
   ç¡®è®¤æ— éœ€å†æ¬¡æ‰§è¡Œåï¼Œå¯ä»¥åˆ é™¤
   ```

3. **ç»§ç»­åç»­å¼€å‘**
   - æ›´æ–°ç°æœ‰äº‘å‡½æ•°ï¼ˆæ·»åŠ æƒé™æ§åˆ¶ï¼‰
   - å¼€å‘æ–°çš„äº‘å‡½æ•°ï¼ˆget_my_projects ç­‰ï¼‰
   - é‡æ„å‰ç«¯é¡µé¢

---

**ç¥è¿ç§»é¡ºåˆ©ï¼** ğŸ‰
